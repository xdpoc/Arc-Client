local DrawingLib = (function()
    local S = {
        P = game:GetService("Players"),
        RS = game:GetService("RunService"),
        WS = game:GetService("Workspace")
    }
    S.C = S.WS.CurrentCamera
    S.LP = S.P.LocalPlayer

    local C = {
        D = {},
        E = {},
        F = nil
    }

    local U = {
        V2 = function(x,y) return Vector2.new(x or 0, y or 0) end,
        C3 = function(r,g,b) return Color3.fromRGB(r or 255, g or 255, b or 255) end,
        CL = function(n,l,h) return math.clamp(n, l or 0, h or 1) end,
        F = math.floor
    }

    local P = {
        White = U.C3(255,255,255),
        Red = U.C3(255,70,70),
        Green = U.C3(70,255,120),
        Blue = U.C3(70,70,255),
        Yellow = U.C3(255,220,70),
        Purple = U.C3(255,70,255),
        Cyan = U.C3(70,255,255),
        Orange = U.C3(255,140,70),
        Black = U.C3(0,0,0),
        Gray = U.C3(200,200,200)
    }

    local G = {
        E = false,
        B = false,
        C = false,
        T = false,
        H = false,
        N = false,
        HB = false,
        D = false,
        SK = false,
        F = false,
        BC = P.White,
        HC = P.White,
        FC = P.White,
        BS = 1.0,
        BT = 1.25,
        FR = 120,
        FT = 1.5
    }

    local function DR(t, p)
        local s, d = pcall(function() return Drawing.new(t) end)
        if s and d then
            for k, v in pairs(p or {}) do
                pcall(function() d[k] = v end)
            end
            table.insert(C.D, d)
            return d
        end
    end

    local function W2S(w)
        if not S.C then return U.V2(), 0, false end
        local v, vf = S.C:WorldToViewportPoint(w)
        return U.V2(v.X, v.Y), v.Z, vf
    end

    local function VC()
        return U.V2(S.C.ViewportSize.X/2, S.C.ViewportSize.Y/2)
    end

    local function VV(p)
        if not p or not p.Character then return false end
        local c = p.Character
        local h = c:FindFirstChild("Humanoid")
        local r = c:FindFirstChild("HumanoidRootPart")
        return h and r and h.Health > 0
    end

    local function CE(p)
        if C.E[p] then return C.E[p] end
        local e = {}
        
        e.BO = DR("Square", {Thickness = G.BT + 1, Color = P.Black, Filled = false, Visible = false})
        e.B = DR("Square", {Thickness = G.BT, Color = G.BC, Filled = false, Visible = false})
        e.N = DR("Text", {Text = p.Name, Color = P.White, Size = 16, Center = true, Outline = true, OutlineColor = P.Black, Visible = false})
        e.H = DR("Circle", {Radius = 4, Filled = true, Color = G.HC, Transparency = 0.3, NumSides = 16, Visible = false})
        e.TR = DR("Line", {Thickness = 1, Color = G.BC, Visible = false})
        e.HBG = DR("Square", {Color = P.Black, Filled = true, Transparency = 0.5, Visible = false})
        e.HF = DR("Square", {Filled = true, Transparency = 0.2, Visible = false})
        e.DT = DR("Text", {Text = "0M", Color = P.Gray, Size = 13, Center = true, Outline = true, OutlineColor = P.Black, Visible = false})
        
        for i = 1, 8 do
            e["C"..i] = DR("Line", {Thickness = G.BT + 1, Color = G.BC, Visible = false})
        end
        
        e.SK = {
            H = DR("Circle", {Radius = 3, Filled = true, Color = G.HC, Visible = false}),
            T = DR("Square", {Filled = true, Color = G.BC, Transparency = 0.2, Visible = false}),
            LA = DR("Line", {Thickness = 2, Color = G.BC, Transparency = 0.2, Visible = false}),
            RA = DR("Line", {Thickness = 2, Color = G.BC, Transparency = 0.2, Visible = false}),
            LL = DR("Line", {Thickness = 2, Color = G.BC, Transparency = 0.2, Visible = false}),
            RL = DR("Line", {Thickness = 2, Color = G.BC, Transparency = 0.2, Visible = false})
        }
        
        C.E[p] = e
        return e
    end

    local function UC(e, x, y, w, h)
        if not e then return end
        local l = 8
        local ps = {
            {U.V2(x - w/2, y - h/2), U.V2(x - w/2 + l, y - h/2)},
            {U.V2(x - w/2, y - h/2), U.V2(x - w/2, y - h/2 + l)},
            {U.V2(x + w/2, y - h/2), U.V2(x + w/2 - l, y - h/2)},
            {U.V2(x + w/2, y - h/2), U.V2(x + w/2, y - h/2 + l)},
            {U.V2(x - w/2, y + h/2), U.V2(x - w/2 + l, y + h/2)},
            {U.V2(x - w/2, y + h/2), U.V2(x - w/2, y + h/2 - l)},
            {U.V2(x + w/2, y + h/2), U.V2(x + w/2 - l, y + h/2)},
            {U.V2(x + w/2, y + h/2), U.V2(x + w/2, y + h/2 - l)}
        }
        for i = 1, 8 do
            if e["C"..i] then
                e["C"..i].From = ps[i][1]
                e["C"..i].To = ps[i][2]
                e["C"..i].Color = G.BC
                e["C"..i].Thickness = G.BT + 1
                e["C"..i].Visible = G.E and G.C
            end
        end
    end

    local function US(e, c)
        if not c or not e.SK then return end
        local hd = c:FindFirstChild("Head")
        local to = c:FindFirstChild("Torso") or c:FindFirstChild("UpperTorso")
        local la = c:FindFirstChild("Left Arm") or c:FindFirstChild("LeftHand") or c:FindFirstChild("LeftUpperArm")
        local ra = c:FindFirstChild("Right Arm") or c:FindFirstChild("RightHand") or c:FindFirstChild("RightUpperArm")
        local ll = c:FindFirstChild("Left Leg") or c:FindFirstChild("LeftLowerLeg") or c:FindFirstChild("LeftFoot")
        local rl = c:FindFirstChild("Right Leg") or c:FindFirstChild("RightLowerLeg") or c:FindFirstChild("RightFoot")
        
        if hd and e.SK.H then
            local p, _, v = W2S(hd.Position)
            if v then e.SK.H.Position = p; e.SK.H.Visible = G.E and G.SK end
        end
        
        if to and e.SK.T then
            local p, _, v = W2S(to.Position)
            if v then
                e.SK.T.Position = U.V2(p.X - 15, p.Y - 20)
                e.SK.T.Size = U.V2(30, 40)
                e.SK.T.Visible = G.E and G.SK
            end
        end
        
        if la and e.SK.LA and to then
            local lp, lv = W2S(la.Position)
            local tp, tv = W2S(to.Position)
            if lv and tv then
                e.SK.LA.From = tp
                e.SK.LA.To = lp
                e.SK.LA.Visible = G.E and G.SK
            end
        end
        
        if ra and e.SK.RA and to then
            local rp, rv = W2S(ra.Position)
            local tp, tv = W2S(to.Position)
            if rv and tv then
                e.SK.RA.From = tp
                e.SK.RA.To = rp
                e.SK.RA.Visible = G.E and G.SK
            end
        end
        
        if ll and e.SK.LL and to then
            local lp, lv = W2S(ll.Position)
            local tp, tv = W2S(to.Position)
            if lv and tv then
                e.SK.LL.From = U.V2(tp.X, tp.Y + 15)
                e.SK.LL.To = lp
                e.SK.LL.Visible = G.E and G.SK
            end
        end
        
        if rl and e.SK.RL and to then
            local rp, rv = W2S(rl.Position)
            local tp, tv = W2S(to.Position)
            if rv and tv then
                e.SK.RL.From = U.V2(tp.X, tp.Y + 15)
                e.SK.RL.To = rp
                e.SK.RL.Visible = G.E and G.SK
            end
        end
    end

    local function PX(pl)
        if not G.E or not pl or pl == S.LP then return end
        if not VV(pl) then
            if C.E[pl] then
                for _, d in pairs(C.E[pl]) do
                    if type(d) == "table" then
                        for _, sd in pairs(d) do pcall(function() sd.Visible = false end) end
                    else
                        pcall(function() d.Visible = false end)
                    end
                end
            end
            return
        end
        
        local c = pl.Character
        local r = c and c:FindFirstChild("HumanoidRootPart")
        local h = c and c:FindFirstChild("Humanoid")
        if not r or not h then return end
        
        local v2, d3, vf = W2S(r.Position)
        if not vf then return end
        
        local e = CE(pl)
        local s = U.CL(650 / (d3 + 0.01) * G.BS, 0.6, 2.5)
        local w = U.F(45 * s)
        local hx = U.F(90 * s)
        local x, y = v2.X, v2.Y
        
        if e.B and e.BO then
            e.B.Position = U.V2(x - w/2, y - hx/2)
            e.B.Size = U.V2(w, hx)
            e.B.Color = G.BC
            e.B.Thickness = G.BT
            e.B.Visible = G.E and G.B
            
            e.BO.Position = U.V2(x - w/2 - 1, y - hx/2 - 1)
            e.BO.Size = U.V2(w + 2, hx + 2)
            e.BO.Thickness = G.BT + 1
            e.BO.Visible = G.E and G.B
        end
        
        if G.C then UC(e, x, y, w, hx) else for i = 1, 8 do if e["C"..i] then e["C"..i].Visible = false end end end
        
        if e.TR and S.C then
            e.TR.From = VC()
            e.TR.To = U.V2(x, y)
            e.TR.Color = G.BC
            e.TR.Visible = G.E and G.T
        end
        
        if e.H and c:FindFirstChild("Head") then
            local hp, hv = W2S(c.Head.Position)
            if hv then
                e.H.Position = hp
                e.H.Color = G.HC
                e.H.Visible = G.E and G.H
            end
        end
        
        if e.N then
            e.N.Position = U.V2(x, y - hx/2 - 22)
            e.N.Text = string.upper(pl.Name)
            e.N.Visible = G.E and G.N
        end
        
        if e.HBG and e.HF then
            local hp = h.Health / h.MaxHealth
            local hc = hp > 0.6 and P.Green or hp > 0.3 and P.Yellow or P.Red
            e.HBG.Position = U.V2(x + w/2 + 5, y - hx/2)
            e.HBG.Size = U.V2(5, hx)
            e.HBG.Visible = G.E and G.HB
            
            e.HF.Position = U.V2(x + w/2 + 5, y + hx/2 - (hx * hp))
            e.HF.Size = U.V2(5, hx * hp)
            e.HF.Color = hc
            e.HF.Visible = G.E and G.HB
        end
        
        if e.DT and S.LP.Character and S.LP.Character:FindFirstChild("HumanoidRootPart") then
            local lr = S.LP.Character.HumanoidRootPart
            local d = U.F((lr.Position - r.Position).Magnitude)
            e.DT.Position = U.V2(x, y + hx/2 + 20)
            e.DT.Text = d .. "M"
            e.DT.Visible = G.E and G.D
        end
        
        if G.SK then US(e, c) end
    end

    local function CL()
        for p, _ in pairs(C.E) do
            if not p or not p.Parent or not VV(p) then
                if C.E[p] then
                    for _, d in pairs(C.E[p]) do
                        if type(d) == "table" then
                            for _, sd in pairs(d) do pcall(function() sd:Remove() end) end
                        else
                            pcall(function() d:Remove() end)
                        end
                    end
                    C.E[p] = nil
                end
            end
        end
    end

    local M = {}

    function M.Enable() G.E = true end
    function M.Disable() G.E = false end
    function M.Toggle() G.E = not G.E end
    function M.IsEnabled() return G.E end
    
    function M.SetState(k, v) if G[k] ~= nil then G[k] = v end end
    function M.SetBoxColor(c) G.BC = P[c] or P.White end
    function M.SetHeadColor(c) G.HC = P[c] or P.White end
    function M.SetFOVColor(c) G.FC = P[c] or P.White if C.F then pcall(function() C.F.Color = G.FC end) end end
    function M.SetBoxScale(v) G.BS = v end
    function M.SetBoxThickness(v) G.BT = v end
    function M.SetFOVRadius(v) G.FR = v if C.F then pcall(function() C.F.Radius = v end) end end
    function M.SetFOVThickness(v) G.FT = v if C.F then pcall(function() C.F.Thickness = v end) end end

    function M.InitFOV()
        if not C.F then
            C.F = DR("Circle", {
                Radius = G.FR,
                Color = G.FC,
                Thickness = G.FT,
                Filled = false,
                NumSides = 64,
                Visible = false,
                Position = VC()
            })
        end
    end

    function M.ToggleFOV(v)
        G.F = v
        if v then
            if not C.F then M.InitFOV() end
            if C.F then pcall(function() C.F.Visible = true end) end
        elseif C.F then
            pcall(function() C.F.Visible = false end)
        end
    end

    function M.Reset()
        for _, d in pairs(C.D) do pcall(function() d:Remove() end) end
        C.D = {}; C.E = {}; C.F = nil
    end

    function M.Update()
        if not S.C then S.C = S.WS.CurrentCamera end
        if not S.C then return end
        
        if C.F and G.F then
            pcall(function() C.F.Position = VC(); C.F.Visible = true end)
        elseif C.F then
            pcall(function() C.F.Visible = false end)
        end
        
        if G.E then
            for _, p in ipairs(S.P:GetPlayers()) do
                if p ~= S.LP then PX(p) end
            end
            CL()
        end
    end

    S.RS.RenderStepped:Connect(function() M.Update() end)

    return M
end)()

return DrawingLib
